<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Delivery App Completo</title>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, query, orderBy, where, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDhxzoRmrYhuIwKkFtlF_H36NklLwVXSN0",
    authDomain: "deliveryapp-a6c48.firebaseapp.com",
    projectId: "deliveryapp-a6c48",
    storageBucket: "deliveryapp-a6c48.firebasestorage.app",
    messagingSenderId: "547092721941",
    appId: "1:547092721941:web:b0feaefe7d6265c32bf91c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  window.firebaseApp = app;
  window.db = db;
  window.firestore = {
    collection, addDoc, getDocs, updateDoc, doc, onSnapshot, query, orderBy, where, deleteDoc, writeBatch
  };
</script>

<style>
  body {margin:0;font-family:'Segoe UI',sans-serif;background:#1c0035;color:#fff;}
  .top {display:flex;justify-content:space-between;align-items:center;padding:12px;background:#3a0060;}
  .top button {background:#fff;color:#3a0060;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:bold;}
  .main {padding:12px;}
  .hero {width:100%;height:60vh;border-radius:10px;overflow:hidden;display:flex;justify-content:center;align-items:center;font-size:26px;background:url('banner-inicial.jpg') center/cover no-repeat;}
  .hero div {background: rgba(0,0,0,0.6); padding:25px; border-radius:12px; text-align:center;}
  .nav {position:fixed;bottom:0;left:0;right:0;background:#3a0060;padding:10px;display:flex;justify-content:space-around;}
  .nav button {background:#fff;color:#3a0060;border:none;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:bold;}
  .card {background:#fff;color:#000;padding:12px;border-radius:10px;margin:10px 0;box-shadow:0 4px 6px rgba(0,0,0,0.2);}
  .card img {width:100%;height:180px;object-fit:cover;border-radius:8px;}
  .card button {cursor:pointer;}
  .loading {color: #fff; text-align: center; padding: 25px; font-size:18px;}
  .upload-area {border: 2px dashed #ccc; padding: 25px; text-align: center; margin: 12px 0; border-radius: 10px; transition:0.3s;}
  .upload-area.active {border-color: #3a0060; background: #f9f9f9;}
  .file-info {background: #e8f4fd; padding: 12px; border-radius: 6px; margin: 12px 0; color: #000; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .btn {background: #3a0060; color: white; padding: 12px 18px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; font-weight:bold; transition:0.2s; display:block; width:100%; box-sizing:border-box;}
  .btn:hover {background: #5a0080;}
  .btn-ghost {background: #fff; color: #3a0060; padding: 12px 18px; border: 1px solid #3a0060; border-radius: 6px; cursor: pointer; margin: 5px; font-weight:bold; transition:0.2s; display:block; width:100%; box-sizing:border-box;}
  .btn-ghost:hover {background: #f3f3f3;}
  .btn-disabled {background: #ccc; color: #666; cursor: not-allowed;}
  .category-item {padding: 18px; margin: 12px 0; background: #fff; color: #000; border-radius: 10px; cursor: pointer; text-align: center; font-weight:bold; transition:0.2s; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .category-item:hover {background: #f3f3f3;}
  .pix-info {background: #e6fff0; padding: 18px; border-radius: 10px; margin: 12px 0; color: #000; border-left: 5px solid #32a852; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .notification-badge {background: #ff4444; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; display: flex; align-items: center; justify-content: center; position: absolute; top: -6px; right: -6px; font-weight:bold;}
  .notification-btn {position: relative;}
  .notification-alert {background: #ff4444 !important; color: white !important; animation: pulse 1.5s infinite;}
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }
  .input-field {width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;font-size:16px;}
  a {color: #3a0060; font-weight:bold;}
  .button-group {display:flex;flex-direction:column;gap:10px;margin-top:15px;}
  .admin-buttons {display:flex;flex-direction:column;gap:8px;margin-top:10px;}
  .admin-buttons .btn {margin:2px 0;padding:10px 14px;font-size:14px;}
</style>
</head>
<body>

<div class="top">
  <button onclick="goBack()">← Voltar</button>
  <button onclick="openContact()">Contato</button>
  <strong>Delivery</strong>
  <button id="userNotifBtn" class="notification-btn" onclick="openUser()">
    Usuário/Admin
    <span id="userNotificationCounter" class="notification-badge" style="display: none">0</span>
  </button>
</div>

<div class="main">
  <div id="view"></div>
</div>

<div class="nav">
  <button onclick="showHome()">Início</button>
  <button onclick="showCategories()">Categoria</button>
  <button onclick="showCart()">Carrinho</button>
  <button id="notifBtn" class="notification-btn" onclick="showNotifs()">
    Notificações
    <span id="notificationCounter" class="notification-badge" style="display: none">0</span>
  </button>
</div>

<script>
const BOT_TOKEN = '8205702578:AAFw4c3aRUR5oDDhH5WWAdOctM9rPLOIHac';
const CHAT_ID = '1232955171';
const STORAGE_KEY = 'delivery_app_data';

let cart = [];
let notifications = [];
let userNotifications = [];
let orders = [];
let currentView = 'home';
let unreadNotifications = 0;
let unreadUserNotifications = 0;
let categories = ["Pizza", "Bebidas", "Sobremesas"];
let products = [
  {id:1,categoria:"Pizza",nome:"Pizza Calabresa",descricao:"Pizza com borda de requeijão",preco:30.00,imagem:"pizza-calabresa.jpg"}
];

// FIREBASE FUNCTIONS
async function salvarPedidoFirebase(pedido) {
  try {
    const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, "pedidos"), {
      ...pedido,
      timestamp: new Date(),
      status: 'Pedido realizado - Aguardando confirmação do pagamento'
    });
    console.log("Pedido salvo no Firebase com ID: ", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("Erro ao salvar pedido: ", e);
    throw e;
  }
}

async function carregarPedidosFirebase() {
  try {
    const querySnapshot = await window.firestore.getDocs(
      window.firestore.query(
        window.firestore.collection(window.db, "pedidos"),
        window.firestore.orderBy("timestamp", "desc")
      )
    );
    
    orders = [];
    querySnapshot.forEach((doc) => {
      orders.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    return orders;
  } catch (e) {
    console.error("Erro ao carregar pedidos: ", e);
    return [];
  }
}

async function atualizarStatusFirebase(pedidoId, novoStatus) {
  try {
    const pedidoRef = window.firestore.doc(window.db, "pedidos", pedidoId);
    await window.firestore.updateDoc(pedidoRef, {
      status: novoStatus,
      ultimaAtualizacao: new Date()
    });
    console.log("Status atualizado com sucesso");
    return true;
  } catch (e) {
    console.error("Erro ao atualizar status: ", e);
    return false;
  }
}

async function limparDadosAntigos() {
  try {
    const doisDiasAtras = new Date();
    doisDiasAtras.setDate(doisDiasAtras.getDate() - 2);
    
    const pedidosQuery = window.firestore.query(
      window.firestore.collection(window.db, "pedidos"),
      window.firestore.where("timestamp", "<", doisDiasAtras)
    );
    
    const pedidosSnapshot = await window.firestore.getDocs(pedidosQuery);
    
    const batch = window.firestore.writeBatch(window.db);
    
    pedidosSnapshot.forEach((doc) => {
      batch.delete(doc.ref);
    });
    
    await batch.commit();
    console.log("Dados antigos limpos com sucesso");
  } catch (e) {
    console.error("Erro ao limpar dados antigos: ", e);
  }
}

function iniciarOuvintePedidos() {
  const q = window.firestore.query(
    window.firestore.collection(window.db, "pedidos"),
    window.firestore.orderBy("timestamp", "desc")
  );
  
  window.firestore.onSnapshot(q, (snapshot) => {
    let novosPedidos = 0;
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added") {
        console.log("Novo pedido: ", change.doc.data());
        novosPedidos++;
      }
    });
    
    if (novosPedidos > 0) {
      unreadNotifications += novosPedidos;
      updateNotificationCounter();
    }
    
    carregarPedidosFirebase().then(() => {
      if (currentView === 'admin') {
        showAdminOrders();
      }
    });
  });
}

// LOCALSTORAGE FUNCTIONS
function loadFromStorage() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const data = JSON.parse(stored);
      cart = data.cart || [];
      userNotifications = data.userNotifications || [];
      unreadUserNotifications = data.unreadUserNotifications || 0;
      updateUserNotificationCounter();
    }
  } catch (e) {
    console.error('Erro ao carregar dados:', e);
  }
}

function saveToStorage() {
  const data = {
    cart: cart,
    userNotifications: userNotifications,
    unreadUserNotifications: unreadUserNotifications
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function clearStorage() {
  cart = [];
  userNotifications = [];
  unreadUserNotifications = 0;
  localStorage.removeItem(STORAGE_KEY);
}

function updateNotificationCounter() {
  const counter = document.getElementById('notificationCounter');
  const notifBtn = document.getElementById('notifBtn');
  
  if (unreadNotifications > 0) {
    counter.style.display = 'flex';
    counter.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
    notifBtn.classList.add('notification-alert');
  } else {
    counter.style.display = 'none';
    notifBtn.classList.remove('notification-alert');
  }
}

function updateUserNotificationCounter() {
  const counter = document.getElementById('userNotificationCounter');
  const notifBtn = document.getElementById('userNotifBtn');
  
  if (unreadUserNotifications > 0) {
    counter.style.display = 'flex';
    counter.textContent = unreadUserNotifications > 99 ? '99+' : unreadUserNotifications;
    notifBtn.classList.add('notification-alert');
  } else {
    counter.style.display = 'none';
    notifBtn.classList.remove('notification-alert');
  }
  saveToStorage();
}

function addNotification() {
  unreadNotifications++;
  updateNotificationCounter();
}

function addUserNotification() {
  unreadUserNotifications++;
  updateUserNotificationCounter();
}

async function sendTelegramNotification(pedido) {
  const message = `🆕 *NOVO PEDIDO N° ${pedido.codigo}*\n\n*Resumo do Pedido:*\n💰 *Total:* R$ ${pedido.total.toFixed(2)}\n📍 *Endereço:* ${pedido.local}\n📱 *Telefone:* ${pedido.whatsapp}\n📋 *Itens:* ${pedido.produtos.map(p => `${p.nome} (x${p.qtd})`).join(', ')}\n⏰ *Data:* ${pedido.data}\n\n_Pedido realizado - Aguardando confirmação do pagamento_`;
  
  try {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chat_id: CHAT_ID,
        text: message,
        parse_mode: 'Markdown'
      })
    });
    
    const result = await response.json();
    if (!result.ok) {
      console.error('Erro Telegram:', result);
      throw new Error('Erro ao enviar para Telegram');
    }
    return true;
  } catch (error) {
    console.error('Erro ao conectar com Telegram:', error);
    throw error;
  }
}

function goBack(){
  if(currentView === 'categories' || currentView === 'category-products' || currentView === 'cart' || currentView === 'notifs' || currentView === 'admin' || currentView === 'user-notifs'){
    showHome();
  } else if(currentView === 'product-list'){
    showCategories();
  }
}

function openContact(){ 
  alert("Telefone: (11) 99999-9999\nEmail: contato@delivery.com\nChave PIX: 123.456.789-00"); 
}

function openUser(){
  let tipo = prompt("Digite 'admin' para acessar admin, deixe vazio para usuário:");
  if(tipo && tipo.toLowerCase()==='admin'){
    let email = prompt("Email:");
    let senha = prompt("Senha:");
    if(email==="admin@local" && senha==="admin123"){ 
      showAdminOrders(); 
    } else {
      alert("Credenciais inválidas");
    }
  } else {
    showUserNotifications();
  }
}

function showHome(){
  currentView = 'home';
  document.getElementById('view').innerHTML = `
    <div class='hero'>
      <div>
        <h2 style="margin:0 0 8px 0">Bem-vindo ao Delivery</h2>
        <p style="margin:0">Peça suas pizzas favoritas!</p>
      </div>
    </div>`;
}

function showCategories(){
  currentView = 'categories';
  let html = "<h3>Categorias</h3>";
  categories.forEach(category => {
    html += `<div class='category-item' onclick='showCategoryProducts("${category}")'>
      <h4 style="margin:0">${category}</h4>
    </div>`;
  });
  document.getElementById('view').innerHTML = html;
}

function showCategoryProducts(categoryName){
  currentView = 'category-products';
  let html = `<h3>Categoria: ${categoryName}</h3>`;
  const categoryProducts = products.filter(p => p.categoria === categoryName);
  
  if(categoryProducts.length === 0){
    html += '<p>Nenhum produto disponível nesta categoria.</p>';
  } else {
    categoryProducts.forEach(p => {
      html += `<div class='card'>
        <img src='${p.imagem}' alt='${p.nome}' onerror="this.src='https://via.placeholder.com/400x200?text=Imagem+Não+Encontrada'"/>
        <h4 style="margin:8px 0 6px 0">${p.nome}</h4>
        <p style="margin:0 0 8px 0">${p.descricao}</p>
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <button class="btn" onclick='addToCart(${p.id})'>Adicionar ao Carrinho</button>
          <span style='margin-left:10px; font-weight:bold'>R$ ${p.preco.toFixed(2)}</span>
        </div>
      </div>`;
    });
  }
  
  html += `<button class="btn-ghost" onclick="showCategories()" style="margin-top: 15px;">← Voltar para Categorias</button>`;
  document.getElementById('view').innerHTML = html;
}

function addToCart(id){
  let p = products.find(x => x.id === id);
  if (!p) return;
  
  let item = cart.find(c => c.id === id);
  if (item) {
    item.qtd++;
  } else {
    cart.push({
      id: p.id,
      nome: p.nome,
      preco: p.preco,
      qtd: 1
    });
  }
  saveToStorage();
  showCart();
  alert(`${p.nome} adicionado ao carrinho!`);
}

function showCart(){
  currentView = 'cart';
  let html = '<h3>Seu Carrinho</h3>';
  
  if(cart.length === 0){ 
    html += '<p>Carrinho vazio</p>';
  } else {
    let total = 0;
    cart.forEach(item => {
      let subtotal = item.preco * item.qtd;
      total += subtotal;
      html += `<div class='card'>
        <b>${item.nome}</b>
        <div style="margin:8px 0">Quantidade: 
          <button class="btn-ghost" onclick='decQty(${item.id})'>-</button> 
          <span style="margin:0 10px">${item.qtd}</span> 
          <button class="btn" onclick='incQty(${item.id})'>+</button>
        </div>
        <div>Subtotal: R$ ${subtotal.toFixed(2)}</div>
      </div>`;
    });
    
    html += `
      <div class='card'>
        <h3>Total: R$ ${total.toFixed(2)}</h3>
        <div class="button-group">
          <button onclick='startCheckout()' class="btn">Finalizar Pedido</button>
          <button onclick='clearCart()' class="btn-ghost">Limpar Carrinho</button>
        </div>
      </div>`;
  }
  
  document.getElementById('view').innerHTML = html;
}

function incQty(id){ 
  let item = cart.find(c => c.id === id); 
  if(item){ 
    item.qtd++; 
    saveToStorage();
    showCart(); 
  } 
}

function decQty(id){ 
  let item = cart.find(c => c.id === id); 
  if(item){ 
    item.qtd--; 
    if(item.qtd <= 0) {
      cart = cart.filter(x => x.id !== id);
    }
    saveToStorage();
    showCart(); 
  } 
}

function clearCart(){ 
  if(confirm('Tem certeza que deseja limpar o carrinho?')){ 
    cart = []; 
    saveToStorage();
    showCart(); 
  } 
}

async function getEnderecoFromCoords(lat, lng) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=pt-BR`);
    const data = await response.json();
    
    if(data && data.address) {
      const addr = data.address;
      
      let enderecoCompleto = '';
      
      if(addr.house_number) enderecoCompleto += addr.house_number + ', ';
      if(addr.road) enderecoCompleto += addr.road;
      if(addr.neighbourhood) enderecoCompleto += ', Bairro ' + addr.neighbourhood;
      if(addr.suburb && addr.suburb !== addr.neighbourhood) enderecoCompleto += ', ' + addr.suburb;
      if(addr.city) enderecoCompleto += ', Cidade ' + addr.city;
      if(addr.state) enderecoCompleto += ' - Estado ' + addr.state;
      
      return {
        endereco: enderecoCompleto || `Localização: ${lat.toFixed(4)}, ${lng.toFixed(4)}`,
        mapaUrl: `https://maps.google.com/?q=${lat},${lng}`,
        bairro: addr.neighbourhood || addr.suburb || '',
        cidade: addr.city || addr.town || addr.village || '',
        estado: addr.state || ''
      };
    }
    return {
      endereco: `Localização: ${lat.toFixed(4)}, ${lng.toFixed(4)}`,
      mapaUrl: `https://maps.google.com/?q=${lat},${lng}`,
      bairro: '',
      cidade: '',
      estado: ''
    };
  } catch (error) {
    console.error('Erro ao buscar endereço:', error);
    return {
      endereco: `Localização: ${lat.toFixed(4)}, ${lng.toFixed(4)}`,
      mapaUrl: `https://maps.google.com/?q=${lat},${lng}`,
      bairro: '',
      cidade: '',
      estado: ''
    };
  }
}

function startCheckout(){
  if(cart.length === 0){ 
    alert('Carrinho vazio'); 
    return; 
  }
  
  if(navigator.geolocation){
    if(confirm('Deseja usar sua localização atual automática?\n\nO app vai detectar seu endereço completo.')){
      document.getElementById('view').innerHTML = '<div class="loading">📍 Detectando sua localização...</div>';
      
      navigator.geolocation.getCurrentPosition(
        async function(position){
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          const localizacaoData = await getEnderecoFromCoords(lat, lng);
          showDadosEntrega(localizacaoData);
        },
        function(error){
          console.log('Erro GPS:', error);
          showDadosEntrega({endereco: '', mapaUrl: '', bairro: '', cidade: '', estado: ''});
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      showDadosEntrega({endereco: '', mapaUrl: '', bairro: '', cidade: '', estado: ''});
    }
  } else {
    showDadosEntrega({endereco: '', mapaUrl: '', bairro: '', cidade: '', estado: ''});
  }
}

function showDadosEntrega(localizacaoData) {
  currentView = 'dados-entrega';
  
  const html = `
    <div class="card">
      <h3>📋 Dados de Entrega</h3>
      ${localizacaoData.endereco ? `
        <p><strong>📍 Endereço detectado:</strong></p>
        <p style="background:#f0f8ff;padding:10px;border-radius:5px;color:#000">${localizacaoData.endereco}</p>
        <p><small>Se o endereço estiver incorreto, edite abaixo:</small></p>
      ` : ''}
      
      <form id="dadosForm">
        <input type="tel" class="input-field" id="whatsapp" placeholder="Seu Telefone (com DDD)" required>
        <input type="text" class="input-field" id="endereco" placeholder="Endereço completo" value="${localizacaoData.endereco || ''}" required>
        <input type="text" class="input-field" id="bairro" placeholder="Bairro" value="${localizacaoData.bairro || ''}" required>
        <input type="text" class="input-field" id="cidade" placeholder="Cidade" value="${localizacaoData.cidade || ''}" required>
        <input type="text" class="input-field" id="estado" placeholder="Estado" value="${localizacaoData.estado || ''}" required>
        <input type="text" class="input-field" id="complemento" placeholder="Complemento ou ponto de referência" maxlength="30">
        <input type="hidden" id="mapaUrl" value="${localizacaoData.mapaUrl || ''}">
        
        <div class="button-group">
          <button type="submit" class="btn">Continuar para Pagamento</button>
          <button type="button" class="btn-ghost" onclick="showCart()">← Voltar</button>
        </div>
      </form>
    </div>
  `;
  
  document.getElementById('view').innerHTML = html;
  
  document.getElementById('dadosForm').onsubmit = function(e) {
    e.preventDefault();
    
    const whatsapp = document.getElementById('whatsapp').value;
    const endereco = document.getElementById('endereco').value;
    const bairro = document.getElementById('bairro').value;
    const cidade = document.getElementById('cidade').value;
    const estado = document.getElementById('estado').value;
    const complemento = document.getElementById('complemento').value;
    const mapaUrl = document.getElementById('mapaUrl').value;
    
    if (!whatsapp || !endereco || !bairro || !cidade || !estado) {
      alert('Por favor, preencha todos os campos obrigatórios.');
      return;
    }
    
    if (whatsapp.replace(/\D/g, '').length < 10) {
      alert('Por favor, insira um telefone válido com DDD.');
      return;
    }
    
    const enderecoCompleto = `${endereco}, ${bairro}, ${cidade} - ${estado}${complemento ? ', ' + complemento : ''}`;
    
    showUploadComprovante({
      endereco: enderecoCompleto,
      mapaUrl: mapaUrl,
      whatsapp: whatsapp,
      bairro: bairro,
      cidade: cidade,
      estado: estado
    }, complemento);
  };
}

function showUploadComprovante(localizacaoData, descricao) {
  currentView = 'checkout';
  let selectedFile = null;
  const totalPedido = cart.reduce((total, item) => total + (item.preco * item.qtd), 0);
  
  const mapaHtml = localizacaoData.mapaUrl ? 
    `<p><strong>📍 Localização no mapa:</strong> <a href="${localizacaoData.mapaUrl}" target="_blank">Abrir no Google Maps</a></p>` : 
    '';
  
  const html = `
    <div class="card">
      <h3>📋 Resumo do Pedido</h3>
      <p><strong>📱 Telefone:</strong> ${localizacaoData.whatsapp}</p>
      <p><strong>📍 Endereço:</strong> ${localizacaoData.endereco}</p>
      ${mapaHtml}
      <p><strong>📝 Complemento:</strong> ${descricao || 'Nenhum'}</p>
      <p><strong>💰 Total:</strong> R$ ${totalPedido.toFixed(2)}</p>
    </div>
    
    <div class="pix-info">
      <h3>💳 Pagamento PIX</h3>
      <p><strong>Chave PIX:</strong> 123.456.789-00</p>
      <p><strong>Valor:</strong> R$ ${totalPedido.toFixed(2)}</p>
      <p><strong>Beneficiário:</strong> Delivery Express</p>
      <p><em>Envie o comprovante do pagamento PIX abaixo</em></p>
    </div>
    
    <div class="card">
      <h3>📎 Enviar Comprovante de Pagamento PIX</h3>
      <p>Envie uma foto ou PDF do comprovante (máximo 2 MB)</p>
      
      <div class="upload-area" id="uploadArea">
        <p>📁 Arraste o arquivo aqui ou clique para selecionar</p>
        <input type="file" id="fileInput" accept="image/*,.pdf" style="display: none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">Selecionar Arquivo</button>
      </div>
      
      <div id="fileInfo"></div>
      
      <div class="button-group">
        <button class="btn" id="submitBtn" disabled onclick="finalizarPedidoComComprovante('${localizacaoData.endereco.replace(/'/g, "\\'")}', '${(descricao || '').replace(/'/g, "\\'")}', '${localizacaoData.mapaUrl.replace(/'/g, "\\'")}', '${localizacaoData.whatsapp.replace(/'/g, "\\'")}')">✅ Finalizar Pedido</button>
        <button class="btn-ghost" onclick="showDadosEntrega({endereco: '${localizacaoData.endereco.replace(/'/g, "\\'")}', mapaUrl: '${localizacaoData.mapaUrl.replace(/'/g, "\\'")}', bairro: '${localizacaoData.bairro.replace(/'/g, "\\'")}', cidade: '${localizacaoData.cidade.replace(/'/g, "\\'")}', estado: '${localizacaoData.estado.replace(/'/g, "\\'")}'})">← Voltar</button>
      </div>
    </div>
  `;
  
  document.getElementById('view').innerHTML = html;
  
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const fileInfo = document.getElementById('fileInfo');
  const submitBtn = document.getElementById('submitBtn');
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('active');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('active');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('active');
    if (e.dataTransfer.files.length) {
      handleFileSelect(e.dataTransfer.files[0]);
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) {
      handleFileSelect(e.target.files[0]);
    }
  });
  
  function handleFileSelect(file) {
    if (file.size > 2 * 1024 * 1024) {
      alert('❌ Arquivo muito grande! Máximo 2 MB permitido.');
      return;
    }
    
    if (!file.type.match('image.*') && !file.type.match('application.pdf')) {
      alert('❌ Formato não permitido! Apenas imagens ou PDF.');
      return;
    }
    
    selectedFile = file;
    
    const fileSize = (file.size / 1024 / 1024).toFixed(2);
    fileInfo.innerHTML = `
      <div class="file-info">
        <strong>📄 ${file.name}</strong><br>
        Tipo: ${file.type}<br>
        Tamanho: ${fileSize} MB<br>
        ✅ Arquivo pronto para envio
      </div>
    `;
    
    submitBtn.disabled = false;
    submitBtn.classList.remove('btn-disabled');
  }
  
  window.finalizarPedidoComComprovante = async function(localizacao, descricao, mapaUrl, whatsapp) {
    if (!selectedFile) {
      alert('❌ Selecione um arquivo de comprovante primeiro!');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = async function(e) {
      const comprovanteBase64 = e.target.result;
      
      let codigoPedido = Math.floor(Math.random() * 900 + 100);
      let totalPedido = cart.reduce((total, item) => total + (item.preco * item.qtd), 0);
      
      let pedido = {
        codigo: codigoPedido,
        produtos: [...cart],
        total: totalPedido,
        local: localizacao,
        mapaUrl: mapaUrl,
        desc: descricao || '',
        whatsapp: whatsapp,
        comprovante: comprovanteBase64,
        comprovanteNome: selectedFile.name,
        comprovanteTipo: selectedFile.type,
        data: new Date().toLocaleString('pt-BR'),
        status: 'Pedido realizado - Aguardando confirmação do pagamento'
      };
      
      try {
        // SALVAR NO FIREBASE
        const pedidoId = await salvarPedidoFirebase(pedido);
        
        // ENVIAR PARA TELEGRAM
        await sendTelegramNotification(pedido);
        
        userNotifications.push({
          codigo: codigoPedido,
          msg: `✅ Pedido #${codigoPedido} confirmado! Aguardando confirmação do pagamento`,
          data: pedido.data
        });
        
        addUserNotification();
        saveToStorage();
        
        alert(`✅ Pedido #${pedido.codigo} confirmado!\n📱 Mensagem enviada para: ${whatsapp}\n💰 Total: R$ ${totalPedido.toFixed(2)}\n📍 Entrega em: ${localizacao}\n\n📢 Notificação enviada para o administrador!`);
        
        cart = [];
        saveToStorage();
        showHome();
      } catch (error) {
        alert('❌ Erro ao finalizar pedido. Tente novamente.');
        console.error('Erro:', error);
      }
    };
    
    reader.onerror = function() {
      alert('❌ Erro ao ler o arquivo. Tente novamente.');
    };
    
    reader.readAsDataURL(selectedFile);
  };
}

function showNotifs(){
  currentView = 'notifs';
  unreadNotifications = 0;
  updateNotificationCounter();
  
  let html = '<h3>Notificações do Sistema</h3>';
  
  if(orders.length === 0){ 
    html += '<p>Nenhuma notificação.</p>';
  } else {
    orders.forEach(pedido => {
      html += `<div class='card'>
        <b>Pedido #${pedido.codigo}</b>
        <div>${pedido.status}</div>
        <small>${pedido.data}</small>
      </div>`;
    });
  }
  
  document.getElementById('view').innerHTML = html;
}

function showUserNotifications(){
  currentView = 'user-notifs';
  unreadUserNotifications = 0;
  updateUserNotificationCounter();
  saveToStorage();
  
  let html = '<h3>Suas Notificações</h3>';
  
  if(userNotifications.length === 0){ 
    html += '<p>Nenhuma notificação.</p>';
  } else {
    userNotifications.slice().reverse().forEach(notif => {
      html += `<div class='card'>
        <b>Pedido #${notif.codigo}</b>
        <div>${notif.msg}</div>
        <small>${notif.data}</small>
      </div>`;
    });
  }
  
  document.getElementById('view').innerHTML = html;
}

async function showAdminOrders(){
  currentView = 'admin';
  
  document.getElementById('view').innerHTML = '<div class="loading">📦 Carregando pedidos...</div>';
  
  await carregarPedidosFirebase();
  
  let html = '<h3>Pedidos - Área Administrativa</h3>';
  
  if(orders.length === 0){ 
    html += '<p>Nenhum pedido realizado.</p>';
  } else {
    orders.forEach(pedido => {
      const comprovanteHtml = pedido.comprovante ? 
        `<p><strong>Comprovante:</strong> 
          <a href="${pedido.comprovante}" target="_blank" download="comprovante_${pedido.codigo}.${pedido.comprovanteTipo === 'application/pdf' ? 'pdf' : 'jpg'}">
            📎 Ver Comprovante (${pedido.comprovanteNome})
          </a>
        </p>` : 
        '<p><strong>Comprovante:</strong> ❌ Não enviado</p>';
      
      const mapaHtml = pedido.mapaUrl ? 
        `<p><strong>📍 Mapa:</strong> <a href="${pedido.mapaUrl}" target="_blank">Abrir localização</a></p>` : 
        '';
      
      html += `<div class='card'>
        <h4>Pedido #${pedido.codigo}</h4>
        <p><strong>📱 Telefone:</strong> ${pedido.whatsapp}</p>
        <p><strong>Status:</strong> ${pedido.status}</p>
        <p><strong>Data:</strong> ${pedido.data}</p>
        <p><strong>Endereço:</strong> ${pedido.local}</p>
        ${mapaHtml}
        <p><strong>Total:</strong> R$ ${pedido.total.toFixed(2)}</p>
        ${comprovanteHtml}
        <p><strong>Itens:</strong> ${pedido.produtos.map(p => `${p.nome} (x${p.qtd})`).join(', ')}</p>
        <div class="admin-buttons">
          <button class="btn" onclick='atualizarStatus("${pedido.id}","Pagamento confirmado - Preparando pedido")'>✅ Confirmar Pagamento</button>
          <button class="btn" onclick='atualizarStatus("${pedido.id}","Pedido em rota de entrega")'>🚚 Saiu para Entrega</button>
          <button class="btn" onclick='atualizarStatus("${pedido.id}","Pedido entregue")'>🎉 Entregue</button>
        </div>
      </div>`;
    });
  }
  
  document.getElementById('view').innerHTML = html;
}

async function atualizarStatus(pedidoId, novoStatus){
  const success = await atualizarStatusFirebase(pedidoId, novoStatus);
  
  if (success) {
    const pedido = orders.find(o => o.id === pedidoId);
    if (pedido) {
      userNotifications.push({
        codigo: pedido.codigo,
        msg: `🔄 Pedido #${pedido.codigo} atualizado: ${novoStatus}`,
        data: new Date().toLocaleString('pt-BR')
      });
      
      addUserNotification();
      saveToStorage();
      
      alert(`✅ Status do pedido #${pedido.codigo} atualizado para: ${novoStatus}\n📱 Mensagem enviada para o cliente: ${pedido.whatsapp}`);
      showAdminOrders();
    }
  } else {
    alert('❌ Erro ao atualizar status do pedido');
  }
}

window.showHome = showHome;
window.showCategories = showCategories;
window.showCategoryProducts = showCategoryProducts;
window.showCart = showCart;
window.showNotifs = showNotifs;
window.showUserNotifications = showUserNotifications;
window.addToCart = addToCart;
window.incQty = incQty;
window.decQty = decQty;
window.clearCart = clearCart;
window.startCheckout = startCheckout;
window.showAdminOrders = showAdminOrders;
window.atualizarStatus = atualizarStatus;
window.openContact = openContact;
window.openUser = openUser;
window.goBack = goBack;

// Aguardar Firebase carregar e iniciar
setTimeout(() => {
  loadFromStorage();
  showHome();
  iniciarOuvintePedidos();
  limparDadosAntigos();
}, 1000);
</script>

</body>
</html>
